{"version":3,"file":"EditorContainer.js","sourceRoot":"","sources":["EditorContainer.tsx"],"names":[],"mappings":"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","sourcesContent":["import React, { KeyboardEvent } from 'react';\nimport classNames from 'classnames';\nimport { isElement, isValidElementType } from 'react-is';\n\nimport { CalculatedColumn, Editor, EditorProps, RowData, CommitEvent } from '../types';\nimport SimpleTextEditor from './SimpleTextEditor';\nimport ClickOutside from './ClickOutside';\n\nexport interface Props {\n  rowIdx: number;\n  rowData: RowData;\n  value: any;\n  column: CalculatedColumn;\n  width: number;\n  height: number;\n  left: number;\n  top: number;\n  onGridKeyDown?(e: KeyboardEvent<HTMLElement>): void;\n  onCommit(e: CommitEvent): void;\n  onCommitCancel(): void;\n  firstEditorKeyPress: string | null;\n  scrollLeft: number;\n  scrollTop: number;\n}\n\ninterface State {\n  isInvalid: boolean;\n}\n\nexport default class EditorContainer extends React.Component<Props, State> {\n  static displayName = 'EditorContainer';\n\n  changeCommitted = false;\n  changeCanceled = false;\n\n  private readonly editor = React.createRef<Editor>();\n  readonly state: Readonly<State> = { isInvalid: false };\n\n  componentDidMount() {\n    const inputNode = this.getInputNode();\n    if (inputNode instanceof HTMLElement) {\n      inputNode.focus();\n      if (!this.getEditor().disableContainerStyles) {\n        inputNode.className += ' editor-main';\n        inputNode.style.height = `${this.props.height - 1}px`;\n      }\n    }\n    if (inputNode instanceof HTMLInputElement) {\n      inputNode.select();\n    }\n  }\n\n  componentDidUpdate(prevProps: Props) {\n    if (prevProps.scrollLeft !== this.props.scrollLeft || prevProps.scrollTop !== this.props.scrollTop) {\n      this.commitCancel();\n    }\n  }\n\n  componentWillUnmount() {\n    if (!this.changeCommitted && !this.changeCanceled) {\n      this.commit({ key: 'Enter' });\n    }\n  }\n\n  onKeyDown = (e: KeyboardEvent<HTMLElement>) => {\n    switch (e.key) {\n      case 'Enter':\n        this.onPressEnter();\n        break;\n      case 'Tab':\n        this.onPressTab();\n        break;\n      case 'Escape':\n        this.onPressEscape(e);\n        break;\n      case 'ArrowUp':\n      case 'ArrowDown':\n        this.onPressArrowUpOrDown(e);\n        break;\n      case 'ArrowLeft':\n        this.onPressArrowLeft(e);\n        break;\n      case 'ArrowRight':\n        this.onPressArrowRight(e);\n        break;\n      default:\n        break;\n    }\n\n    if (this.props.onGridKeyDown) {\n      this.props.onGridKeyDown(e);\n    }\n  };\n\n  createEditor() {\n    const editorProps: EditorProps & { ref: React.RefObject<Editor> } = {\n      ref: this.editor,\n      column: this.props.column,\n      value: this.getInitialValue(),\n      rowMetaData: this.getRowMetaData(),\n      rowData: this.props.rowData,\n      height: this.props.height,\n      onCommit: this.commit,\n      onCommitCancel: this.commitCancel,\n      onBlur: this.commit,\n      onOverrideKeyDown: this.onKeyDown\n    };\n\n    const CustomEditor = this.props.column.editor;\n    // return custom column editor or SimpleEditor if none specified\n    if (isElement(CustomEditor)) {\n      return React.cloneElement(CustomEditor, editorProps);\n    }\n    if (isValidElementType(CustomEditor)) {\n      return <CustomEditor {...editorProps} />;\n    }\n\n    return (\n      <SimpleTextEditor\n        ref={this.editor as React.RefObject<SimpleTextEditor>}\n        column={this.props.column as CalculatedColumn<string>}\n        value={this.getInitialValue() as string}\n        onBlur={this.commit}\n      />\n    );\n  }\n\n  onPressEnter = () => {\n    this.commit({ key: 'Enter' });\n  };\n\n  onPressTab = () => {\n    this.commit({ key: 'Tab' });\n  };\n\n  onPressEscape = (e: KeyboardEvent) => {\n    if (!this.editorIsSelectOpen()) {\n      this.commitCancel();\n    } else {\n      // prevent event from bubbling if editor has results to select\n      e.stopPropagation();\n    }\n  };\n\n  onPressArrowUpOrDown = (e: KeyboardEvent) => {\n    if (this.editorHasResults()) {\n      // dont want to propogate as that then moves us round the grid\n      e.stopPropagation();\n    } else {\n      this.commit(e);\n    }\n  };\n\n  onPressArrowLeft = (e: KeyboardEvent) => {\n    // prevent event propogation. this disables left cell navigation\n    if (!this.isCaretAtBeginningOfInput()) {\n      e.stopPropagation();\n    } else {\n      this.commit(e);\n    }\n  };\n\n  onPressArrowRight = (e: KeyboardEvent) => {\n    // prevent event propogation. this disables right cell navigation\n    if (!this.isCaretAtEndOfInput()) {\n      e.stopPropagation();\n    } else {\n      this.commit(e);\n    }\n  };\n\n  editorHasResults = () => {\n    const { hasResults } = this.getEditor();\n    return hasResults ? hasResults() : false;\n  };\n\n  editorIsSelectOpen = () => {\n    const { isSelectOpen } = this.getEditor();\n    return isSelectOpen ? isSelectOpen() : false;\n  };\n\n  getRowMetaData() {\n    // clone row data so editor cannot actually change this\n    // convention based method to get corresponding Id or Name of any Name or Id property\n    if (this.props.column.getRowMetaData) {\n      return this.props.column.getRowMetaData(this.props.rowData, this.props.column);\n    }\n  }\n\n  getEditor = () => {\n    return this.editor.current!;\n  };\n\n  getInputNode = () => {\n    return this.getEditor().getInputNode();\n  };\n\n  getInitialValue() {\n    const { firstEditorKeyPress: key, value } = this.props;\n    if (key === 'Delete' || key === 'Backspace') {\n      return '';\n    }\n    if (key === 'Enter') {\n      return value;\n    }\n\n    return key || value;\n  }\n\n  commit = (args: { key?: string } = {}) => {\n    const { onCommit } = this.props;\n    const updated = this.getEditor().getValue();\n    if (this.isNewValueValid(updated)) {\n      this.changeCommitted = true;\n      const cellKey = this.props.column.key;\n      onCommit({ cellKey, rowIdx: this.props.rowIdx, updated, key: args.key });\n    }\n  };\n\n  commitCancel = () => {\n    this.changeCanceled = true;\n    this.props.onCommitCancel();\n  };\n\n  isNewValueValid = (value: any) => {\n    const { validate } = this.getEditor();\n    if (validate) {\n      const isValid = validate(value);\n      this.setState({ isInvalid: !isValid });\n      return isValid;\n    }\n\n    return true;\n  };\n\n  isCaretAtBeginningOfInput = () => {\n    const inputNode = this.getInputNode();\n    return inputNode instanceof HTMLInputElement\n      && inputNode.selectionEnd === 0;\n  };\n\n  isCaretAtEndOfInput = () => {\n    const inputNode = this.getInputNode();\n    return inputNode instanceof HTMLInputElement\n      && inputNode.selectionStart === inputNode.value.length;\n  };\n\n  handleRightClick = (e: React.MouseEvent<HTMLDivElement>) => {\n    e.stopPropagation();\n  };\n\n  renderStatusIcon() {\n    return this.state.isInvalid\n      && <span className=\"glyphicon glyphicon-remove form-control-feedback\" />;\n  }\n\n  render() {\n    const { width, height, left, top } = this.props;\n    const className = classNames('rdg-editor-container', {\n      'has-error': this.state.isInvalid === true\n    });\n\n    return (\n      <ClickOutside onClickOutside={this.commit}>\n        <div\n          className={className}\n          style={{ height, width, left, top }}\n          onKeyDown={this.onKeyDown}\n          onContextMenu={this.handleRightClick}\n        >\n          {this.createEditor()}\n          {this.renderStatusIcon()}\n        </div>\n      </ClickOutside>\n    );\n  }\n}\n"]}